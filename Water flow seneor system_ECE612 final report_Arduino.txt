#include <SoftwareSerial.h>
#include <Printers.h>
#include <XBee.h>
SoftwareSerial xbee(5, 2);
int flowPin = 3;    //This is the input pin on the Arduino
double flowRate;    //This is the value we intend to calculate. 
volatile int count; //This integer needs to be set as volatile to ensure it updates correctly during the interrupt process.  
double v;
 
void setup() {
  // put your setup code here, to run once:
  pinMode(flowPin, INPUT);           //Sets the pin as an input
  attachInterrupt(0, Flow, RISING);  //Configures interrupt 0 to run the function "Flow"  
  Serial.begin(9600);  //Start Serial
  xbee.begin(9600);
}
void loop() {
  // put your main code here, to run repeatedly:  
  count = 0;      // Reset the counter so we start counting from 0 again
  interrupts();   //Enables interrupts on the Arduino
  delay (1000);   //Wait 1 second 
  noInterrupts(); //Disable the interrupts on the Arduino
 
  //Start the math
  flowRate = (count * 2.25);        //Take counted pulses in the last second and multiply by 2.25mL 
  flowRate = flowRate * 60;         //Convert seconds to minutes, giving you mL / Minute
  flowRate = flowRate / 1000;       //Convert mL to Liters, giving you Liters / Minute
  v=flowRate * 1000;                //Convert Liters / Min to cm^3/min         
  v=v / 1.1304;                     //Compute velocity of vehicle(cm/min) the cross-sectional area of water pipe is 1.1304 cm^2
  v=v / 100;                        //Convert cm/min to m/min
  Serial.print(flowRate); 
  Serial.println("  Liters/min");
  Serial.print(v);                  //Vehicle's velocity
  Serial.println("  Meter/min");
  xbee.print(flowRate);
  xbee.print(v);
}
 
void Flow()
{
   count++; //Every time this function is called, increment "count" by 1
}